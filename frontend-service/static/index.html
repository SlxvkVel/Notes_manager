<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–º–µ—Ç–æ–∫</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        input, textarea, button { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .note { border: 1px solid #eee; padding: 10px; margin: 10px 0; background: #f9f9f9; }
        .auth-buttons { display: flex; gap: 10px; }
        .auth-buttons button { flex: 1; }
        .auth-form { display: none; margin-top: 10px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background: #f8f9fa; }
        .user-info { display: none; margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üìù –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–º–µ—Ç–æ–∫</h1>
    <div class="container">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
        <div class="auth-buttons">
            <button onclick="toggleForm('registerForm')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button onclick="toggleForm('loginForm')">–í—Ö–æ–¥</button>
            <button onclick="logout()" style="background: #6c757d;">–í—ã—Ö–æ–¥</button>
        </div>
        <div id="registerForm" class="auth-form">
            <h4>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h4>
            <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
            <input type="email" id="regEmail" placeholder="Email" required>
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <button onclick="toggleForm('registerForm')" style="background: #6c757d; margin-top: 5px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div id="loginForm" class="auth-form">
            <h4>–í—Ö–æ–¥</h4>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <button onclick="toggleForm('loginForm')" style="background: #6c757d; margin-top: 5px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div id="userInfo" class="user-info">
            <strong>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <span id="currentUser"></span></strong>
        </div>
    </div>
    <div class="container">
        <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</h3>
        <input type="text" id="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏">
        <textarea id="content" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏" rows="4"></textarea>
        <button onclick="createNote()">–°–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
    </div>
    <div class="container">
        <h3>–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h3>
        <button onclick="getNotes()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <div id="notes"></div>
    </div>
    <script>
        let currentUsername = '';
        function toggleForm(formId) {
            const forms = document.querySelectorAll('.auth-form');
            forms.forEach(form => {
                form.style.display = 'none';
            });
            const form = document.getElementById(formId);
            if (form.style.display === 'block') {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
            }
            document.getElementById('userInfo').style.display = 'none';
        }
        function showUserInfo(username) {
            currentUsername = username;
            document.getElementById('currentUser').textContent = username;
            document.getElementById('userInfo').style.display = 'block';
            const forms = document.querySelectorAll('.auth-form');
            forms.forEach(form => {
                form.style.display = 'none';
            });
        }
        async function register() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            
            if (!username || !email || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                return;
            }  
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password
                    })
                });   
                const responseText = await response.text();
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(responseText || `HTTP error! status: ${response.status}`);
                    }
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = JSON.parse(responseText);
                document.getElementById('regUsername').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regPassword').value = '';
                toggleForm('registerForm');
                showUserInfo(username);
                alert(`‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`);
            } catch (error) {
                let errorMessage = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                if (error.message.includes('already exists') || error.message.includes('duplicate')) {
                    errorMessage = '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –∏–ª–∏ –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                } else if (error.message.includes('400')) {
                    errorMessage = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                } else if (error.message.includes('500')) {
                    errorMessage = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
                } else {
                    errorMessage = '‚ùå ' + error.message;
                }
                alert(errorMessage);
            }
        }
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                const responseText = await response.text();
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(responseText || `HTTP error! status: ${response.status}`);
                    }
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = JSON.parse(responseText);
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                toggleForm('loginForm');
                showUserInfo(data.username || email.split('@')[0]);
                alert('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                getNotes();
            } catch (error) {
                let errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                if (error.message.includes('401') || error.message.includes('invalid credentials')) {
                    errorMessage = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                } else if (error.message.includes('400')) {
                    errorMessage = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                } else if (error.message.includes('500')) {
                    errorMessage = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
                } else if (error.message.includes('user not found')) {
                    errorMessage = '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                } else {
                    errorMessage = '‚ùå ' + error.message;
                }
                alert(errorMessage);
            }
        }
        async function createNote() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            if (!title || !content) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏');
                return;
            }
            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });
                const responseText = await response.text();
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(responseText || `HTTP error! status: ${response.status}`);
                    }
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = JSON.parse(responseText);
                alert('‚úÖ –ó–∞–º–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                document.getElementById('title').value = '';
                document.getElementById('content').value = '';
                getNotes();
            } catch (error) {
                let errorMessage = '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏';
                if (error.message.includes('401') || error.message.includes('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω')) {
                    errorMessage = '‚ùå –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
                } else if (error.message.includes('400')) {
                    errorMessage = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–º–µ—Ç–∫–∏';
                } else if (error.message.includes('500')) {
                    errorMessage = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
                } else {
                    errorMessage = '‚ùå ' + error.message;
                }

                alert(errorMessage);
            }
        }
        async function getNotes() {
            try {
                const response = await fetch('/api/notes/list', {
                    credentials: 'include'
                });
                
                const responseText = await response.text();
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(responseText || `HTTP error! status: ${response.status}`);
                    }
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }  
                const data = JSON.parse(responseText);
                displayNotes(data.notes);
            } catch (error) {
                let errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–º–µ—Ç–æ–∫'; 
                if (error.message.includes('401') || error.message.includes('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω')) {
                    errorMessage = '‚ùå –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–º–µ—Ç–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
                } else {
                    errorMessage = '‚ùå ' + error.message;
                }
                
                document.getElementById('notes').innerHTML = errorMessage;
            }
        }
        function displayNotes(notes) {
            const container = document.getElementById('notes');
            if (!notes || notes.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</p>';
                return;
            }           
            container.innerHTML = notes.map(note => `
                <div class="note">
                    <h4>${note.title}</h4>
                    <p>${note.content}</p>
                    <small>–°–æ–∑–¥–∞–Ω–æ: ${new Date(note.created_at).toLocaleString()}</small>
                </div>
            `).join('');
        }
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                alert('‚úÖ –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
                document.getElementById('notes').innerHTML = '';
                document.getElementById('userInfo').style.display = 'none';
                currentUsername = '';
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error);
            }
        }
        window.onload = getNotes;
    </script>
</body>
</html>
